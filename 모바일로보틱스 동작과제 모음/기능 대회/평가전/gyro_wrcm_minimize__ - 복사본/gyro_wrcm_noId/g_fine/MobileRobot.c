/************************************************************************************************************/
/*                                                                                                          */
/*                                              MobileRobot.c                                               */
/*                                                                                                          */
/*                                                                                       2020. 1. 1.        */
/************************************************************************************************************/
#include "Interface.h"


#define cw wa = 0;
#define ar acf =cacf= 0;
#define set pos[0] = pos[1] = pos[2] = 0; gyro = rearGyro = 0;
#define V3 while(!Cmd(0,19));
#define SV1 while(!Cmd(0,18));
#define reset bar_1 = bar_2 = bar_3 = bar_4 = bar_5 = sbar_1 = sbar_2= 0;
#define wait if(key) {SS(); while(SW2); while(!SW2);}
#define lcs lcd_clear_screen();

#define ab45(y) wa = 90; AB(0,0,4,196,5,170,30,y);	cw
#define ab345(y) wa = 90; AB(3,122,4,196,5,170,30,y);	cw
#define ab645(y) wa = 90; AB(6,150,4,196,5,170,30,y);	cw
#define ab13(y) AB(0,0,1,165,3,157,30,y);	

int key= 0, key_puck = 0,cm = 0;
int movePoint = 0;
int tmp = 0,bgate = -1;

int gate[4],goal;


int main(void)
{

    Interface_init();

	write_gyro(0x1E, 1); // 지자기 OFF
	write_gyro(0x1E, 5); // 자이로 500dps	
	write_gyro(0x1E, 20); // 능동적 진동성분제거 OFF

	write_gyro(0x1E, 16); // 자이로 보정

	Camera_init();
	Setting(11);
	TM(50);
	V3

	_delay_ms(500);

	set

	LED_ON(3);
	_delay_ms(100);
	LED_OFF(3);

	while(1)
	{		
	    if(SW1)
		{
			key--;
			LED_ON(3);
			_delay_ms(100);
			LED_OFF(3);

		}
	    if(SW3)
		{
			key++;
			LED_ON(3);
			_delay_ms(100);
			LED_OFF(3);

		}
		
		
	    if(SW2)
		{
			lcd_clear_screen();
			LED_ON(3);
			_delay_ms(100);
			LED_OFF(3);

			switch(key)
			{

case 0:
case 1:
case 2 : 

ar ab345(30);

CPsd(12,1,5,3,11,0,40,50);
CPsd(10,1,5,5,11,0,40,0);
Drift(1,35,-90,30,0);


goal = T(101,3);
CPsd(12,1,5,3,11,0,40,50);
CPsd(10,1,20,5,11,0,40,-50);

Axis(0,-15,0,30,40);
ab45(30);

ar ab345(30);
Axis(0,-2,0,10,120);


Drift(25,0,70,30,40);	wa =-20;
Ot(-23,90,90,25,0);


CPsd(12,6,-5,3,13,0,40,0);
sbar_2 = 0;
CPsd(10,6,-5,5,13,0,40,0);
CPsd(6,6,-1000,3,13,22,40,0);

gate[1] = sbar_2;
if(key == 2) gate[1] = 1;

Ad(0,-15,40,40,-50,60);	wa = 20;

Drift(-5,25,70,25,35);	cw


set

CPsd(12,8,3,3,15,0,40,50);
CPsd(10,8,5,5,15,0,40,0);
CPsd(8,8,1000,5,15,25,40,0);


gate[0] = pos[1] > 45;

Drift(0,22,-40,30,0);	wa = -40;
Ot(20,-90,-50,30,0);	cw
Drift(1,28,-90,30,-40);


if(gate[0]){
	cm = 30;
	ar ab345(30);
}

else{
	ar ab13(30);
	cm = 0;
}


if(goal == T(101,3)) {
	set
	CPsd(12,1,3,3,11,0,40,50);
	CPsd(10,1,5+ cm,5,11,0,40,-50);

	Axis(0,-pos[1],0,30,140);


}

if(gate[0]){
	ar ab345(30);
	Axis(0,-1,0,10,120);
}

else{
	ar ab13(30);
}
if(gate[1] == 0){
	Drift(26 - gate[0],0,70,30,40);	
	Ot(-23,90,90,30,0);	wa = -20;

	CPsd(12,6,-3,3,12,0,40,0);
	CPsd(10,6,-3,5,12,0,40,0);
	CPsd(6,6,-1000,3,12,20,40,0);

	Avoid(5,11,15,20,-1000,40,0);
	Ot(-12,-90,-10,30,0);	wa = -30;
	Drift(-13,0,-40,30,0);	wa=  20;
case -1:
	wa = 20;
	CPsd(12,3,-5,3,18,0,40,50 * (key == -1));
	CPsd(10,3,-5,5,18,0,40,0);
	CPsd(-4,3,-1000,5,18,20,40,0);
	Ot(-14,90,0,30,0);	
	Drift(15,-2,50,30,0);	wa =-20;



	wa = -20;
	CPsd(12,6,-5,3,14,0,40,0);
	CPsd(10,6,-5,5,14,0,40,0);
	CPsd(-5,6,-1000,5,14,20,40,0);
	Ot(-12,-90,30,30,0);		wa = -80;

	CPsd(12,3,3,3,14,0,40,0);
	CPsd(10,3,5,5,14,0,40,0);
	CPsd(-2,3,1000,5,14,20,40,0);

	Ot(12,-90,10,30,0);	wa=  20;
	Ot(18,90,70,25,0);	cw
	Ot(5,-90,0,30,0);
	Axis(26,0,0,30,-40);	ar ab645(30);
}

else{
	if(gate[0]){
		Drift(25,0,70,30,40);wa = -20;
		Ot(-23,90,90,30,0);	

		CPsd(12,6,-5,3,11,0,40,0);
		CPsd(10,6,-8,5,11,0,40,0);	
		Ot(-20,-90,-40,30,0);	wa =30;
		Drift(0,-5,-10,30,0);	wa = 20;
	}
	else{
		Drift(40,0,90,30,40);	
		Ot(-10,90,10,35,0);	wa= 100;
		Axis(0,2,0,40,0);
		Ot(10,-90,10,35,0);	wa= 20;
	}

	case -2: 
	wa = 20;
	CPsd(12,5,-5,3,14,0,40,50 * (key == -2));
	CPsd(10,5,-5,5,14,0,40,0);
	CPsd(-4,5,-1000,5,14,20,40,0);
	Ot(-14,-90,-40,30,0);	wa=  -20;

	Drift(-15,-3,-50,30,0);	wa =20;

	CPsd(12,3,-5,3,18,0,40,0);
	CPsd(10,3,-5,5,18,0,40,0);
	CPsd(-4,3,-1000,5,18,20,40,0);

	
	Ot(-12,90,-30,30,0);	wa= 80;

	CPsd(12,6,5,3,18,0,40,0);
	CPsd(10,6,5,5,18,0,40,0);
	CPsd(-7,6,1000,5,18,20,40,0);

	Ot(14,90,0,30,0);	wa = -10;
	Axis(0,6,0,40,0);
	Ot(10,-90,0,30,0);	wa=  80;
	Ot(5,90,10,30,0);	cw

	CPsd(12,1,5,3,12,0,40,0);
	CPsd(10,1,5,5,12,0,40,0);
	CPsd(1,1,1000,3,12,25,40,0);

	Drift(2,25,-70,30,0);	wa = -70;
	Ot(15,90,-20,30,-40);	cw

	ar ab645(30);
}



//////////////////////========================= P RV


case -5:

ar ab645(30);
bar_2 = 0;
Drift(0,20,-20,30,40);	wa= -20;

gate[2] = bar_2;

if(key == -5) gate[2] = 1;


if(gate[2]){
	Drift(5,20,-50,30,0);	wa = -70;
	Ot(10,-90,-20,30,-40 * (key == -4));	cw
	//wait
	CPsd(12,8,5,3,18,0,40,50 * (key == -4));
	CPsd(10,8,5,5,18,0,40,0);
	CPsd(8,8,100,3,18,25,40,0);

	gate[3] = g_psd[2] > 30;

	Drift(1,41,-90,30,0);

	CPsd(12,1,5,3,11,0,40,50);
	CPsd(10,1,10,5,11,0,40,0);
	Drift(0,33,-90,30,0);	cw
	if(T(101,3) == goal)	cm = 15;	
	else cm = 0;

	set
	CPsd(12,1,5,3,11,0,40,50);
	CPsd(10,1,5 + cm,5,11,0,40,-50);

	Axis(0,-pos[1] + 5,0,30,40);
	ab45(30);

	ar ab345(30);


	Axis(0,-2,0,10,120);

	
	if(gate[3] == 0){
		
		Drift(28,0,70,30,40);	wa= -20;
		Ot(-23,90,90,25,0);		

		CPsd(12,4,-3,3,18,0,35,5);
		CPsd(10,4,-3,5,18,0,35,0);
		CPsd(4,4,-1000,3,18,25,35,0);
		
		Axis(0,-24,0,35,0);
		Ot(-20,-90,-50,25,0);	wa = 20;
		Axis(0,-25,0,30,0);
		Ot(-10,90,0,30,0);
		Od2(5,0,70,30,-40,60,130);	cw
	}

	else{
		Drift(28,0,70,30,40);	wa= -20;
		Ot(-23,90,90,25,0);		


		CPsd(12,6,-3,3,14,0,35,5);
		CPsd(10,6,-3,5,14,0,35,0);
		CPsd(6,6,-1000,3,14,20,35,0);

		Avoid(5,14,18,20,-1000,35,0);
		AB(5,180,0,0,0,0,0,35);

		At(20,40);	cw
		Drift(-1,47,90,30,140);

		Avoid(0,11,15,0,10,40,50);
		Drift(3,45,-90,30,-40);

		CPsd(12,8,5,3,18,0,40,50);
		CPsd(10,8,10,5,18,0,40,0);
		Drift(-1,30,90,30,0);	cw

		CPsd(12,8,5,3,15,0,40,50);
		CPsd(10,8,10,5,15,0,40,0);
		Drift(0,35,90,30,0);
		
		CPsd(12,8,5,3,15,0,40,50);
		CPsd(10,8,10,5,15,0,40,-50);
		
	}
	SS();
	break;
	
}




case -4:
///Rverse

ar	ab645(30);

Drift(-10,0,10,30,40);	wa = -80;

CPsd(12,3,5,3,14,0,40,0);
CPsd(10,3,5,5,14,0,40,0);
CPsd(-2,3,1000,3,14,20,40,0);
Ot(12,-90,0,35,0);		wa= 10;

Ot(18,90,0,40,5);	wa=  -80;
Ot(20,-90,-10,40,0);	cw

Axis(0,10,0,50,0);

CPsd(12,8,5,3,16,0,50,0);
CPsd(10,8,5,5,16,0,50,0);
CPsd(8,8,1000,3,16,25,50,0);

Drift(2,34,-90,30,0);	wa=  -90;
Ot(8,-90,0,30,0);	cw

CPsd(12,8,5,3,16,0,40,0);
CPsd(10,8,5,5,16,0,40,0);
CPsd(8,8,1000,3,16,25,40,0);

Drift(0,24,-30,30,0);	wa= -30;
Ot(20,-90,10,30,0);	wa= 70;
Ot(10,90,20,30,-40);	cw



SS();
break;
//return;




///OUT GET
if(gate[1]){
	case -3:
	ar ab645(30);
	Axis(-15,0,0,35,45);	wa = 90;
	Ot(-27,90,20,30,0);	wa = 20;

	Avoid(4,12,16,20,-1000,35,0);
	Ot(-14,90,50,30,0);	wa=  -20;

	CPsd(12,6,-3,3,14,0,35,0);
	CPsd(10,6,-3,5,14,0,35,0);
	CPsd(-5,6,-1000,5,14,20,35,0);
	Ot(-11,-90,0,30,0);
	Drift(-13,0,-50,25,0);	wa = 20;
	CPsd(12,3,-5,3,15,0,40,5);
	CPsd(10,3,-5,5,15,0,40,0);
	CPsd(3,3,-1000,5,15,22,40,0);
	SS();
}

else{

case -6:
	ar ab645(30);

	At(-70,100);	wa= -70;
	Drift(0,10,-20,30,40);	wa= -90;
	Ot(8,-90,0,30,0);	cw	

	CPsd(12,8,5,3,16,0,50,0);
	CPsd(10,8,5,5,16,0,50,0);
	CPsd(8,8,1000,3,16,25,50,0);

	Drift(2,34,-90,40,0);	wa=  -90;
	Ot(8,-90,0,40,0);	cw

	CPsd(12,8,5,3,16,0,50,0);
	CPsd(10,8,5,5,16,0,50,0);
	CPsd(8,8,1000,3,16,25,50,0);

	Drift(0,24,-30,40,0);	wa= -30;
	Ot(20,-90,10,35,0);	wa= 70;
	Ot(10,90,0,35,0);	wa = -20;
	Drift(1,35,-70,30,0);	cw

	CPsd(12,1,3,3,11,0,40,50);
	CPsd(10,1,5,5,11,0,40,0);
	CPsd(1,1,1000,3,11,20,40,0);

	Drift(0,30,-80,30,0);	wa= -80;
	Avoid(2,11,15,12,1000,40,0);	
	Ot(6,90,10,30,0);	wa= 20;
	CPsd(12,5,-3,3,11,0,40,0);
	CPsd(10,5,-5,5,11,0,40,0);
	CPsd(-4,5,-1000,5,11,20,40,0);
	Axis(0,-15,0,40,-50);
}



while(!SW2);
while(SW2);

			}
		}

		if(key){
			lcd(0,0,"%03d %03d %03d %03d %03d",g_psd[2],g_psd[1],g_psd[0],g_psd[8],g_psd[7]);
			lcd(1,0,"%03d %03d      %03d %03d",g_psd[3],g_psd[4],g_psd[5],g_psd[6]);
		}
		else{
			lcd(0,0,"%03d %03d %03d %03d %03d",psd[2],psd[1],psd[0],psd[8],psd[7]);
			lcd(1,0,"%03d %03d      %03d %03d",psd[3],psd[4],psd[5],psd[6]);
		}
		key_puck = abs(key) %9;

		get_gyro();
		lcd(2,0,"C%d X%3d Y%3d S%2d",key_puck,Cmd(key_puck,102),Cmd(key_puck,103),Cmd(key_puck,104));		
		lcd(3,0,"%d%d%d%d%d|%d%d G%04d",IR_4,IR_1,IR_2,IR_3,IR_5,IND_1,IND_2, (int)gyro);
		lcd(3,16,"k:%02d",key);
	}
}

